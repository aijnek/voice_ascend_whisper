{% extends "base.html" %}

{% block title %}éŒ²éŸ³ - Voice Ascend Whisper{% endblock %}

{% block extra_head %}
<style>
    .recording-controls {
        text-align: center;
        margin: 2rem 0;
    }

    .recording-status {
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 8px;
        text-align: center;
    }

    .recording-status.idle {
        background-color: #f0f0f0;
    }

    .recording-status.recording {
        background-color: #ffebee;
        border: 2px solid #e53935;
    }

    .recording-status.processing {
        background-color: #fff3e0;
    }

    .recording-status.success {
        background-color: #e8f5e9;
    }

    .recording-timer {
        font-size: 2rem;
        font-weight: bold;
        color: #e53935;
        margin: 1rem 0;
    }

    .text-display {
        font-size: 1.5rem;
        padding: 2rem;
        background-color: #f5f5f5;
        border-radius: 8px;
        margin: 2rem 0;
        text-align: center;
        min-height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .record-button {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        font-size: 1.5rem;
        margin: 1rem auto;
        display: block;
    }

    .record-button.recording {
        background-color: #e53935;
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    #audioPlayback {
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<h1>éŒ²éŸ³</h1>

<!-- Text Selection -->
<div>
    <div class="grid">
        <div>
            <label for="textSelect">
                ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠ
                <select id="textSelect" onchange="selectText()">
                    <option value="">-- ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                    {% for text in texts %}
                    <option value="{{ text.id }}" {% if selected_text and selected_text.id == text.id %}selected{% endif %}>
                        [ID: {{ text.id }}] {% if text.content|length > 80 %}{{ text.content[:80] }}...{% else %}{{ text.content }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </label>
        </div>
        <div style="display: flex; align-items: flex-end;">
            <label>
                <input type="checkbox" id="showAllToggle" {% if show_all %}checked{% endif %} onchange="toggleShowAll()">
                éŒ²éŸ³æ¸ˆã¿ã‚‚è¡¨ç¤º
            </label>
        </div>
    </div>

    {% if not texts %}
    <p>
        {% if show_all %}
        ã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆãŒéŒ²éŸ³æ¸ˆã¿ã§ã™ã€‚
        {% else %}
        éŒ²éŸ³ã•ã‚Œã¦ã„ãªã„ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚
        {% endif %}
        <a href="/texts/new" role="button">æ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ </a>
    </p>
    {% endif %}
</div>

<!-- Text Display -->
<div class="text-display" id="textDisplay">
    {% if selected_text %}
        {{ selected_text.content }}
    {% else %}
        ä¸Šã®ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„
    {% endif %}
</div>

<!-- Recording Status -->
<div class="recording-status idle" id="statusDisplay">
    <div id="statusMessage">éŒ²éŸ³æº–å‚™å®Œäº†</div>
    <div class="recording-timer" id="timer" style="display: none;">00:00</div>
</div>

<!-- Recording Controls -->
<div class="recording-controls">
    <button
        id="recordButton"
        class="record-button"
        onclick="toggleRecording()"
        disabled
    >
        ğŸ¤ éŒ²éŸ³é–‹å§‹
    </button>

    <div id="playbackSection" style="display: none;">
        <h3>éŒ²éŸ³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
        <audio id="audioPlayback" controls></audio>
        <div>
            <button onclick="saveRecording()" class="primary">ä¿å­˜</button>
            <button onclick="discardRecording()" class="secondary">ç ´æ£„</button>
        </div>
    </div>
</div>

<!-- Results -->
<div id="resultMessage"></div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/recorder.js"></script>
<script>
let recorder = null;
let selectedTextId = null;
let recordedBlob = null;
let timerInterval = null;
let recordingStartTime = null;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    // Check browser support
    if (!AudioRecorder.isSupported()) {
        document.getElementById('statusMessage').textContent = 'ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°éŒ²éŸ³ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“';
        document.getElementById('recordButton').disabled = true;
        return;
    }

    recorder = new AudioRecorder();

    // Pre-select text if provided
    {% if selected_text %}
    selectedTextId = {{ selected_text.id }};
    document.getElementById('recordButton').disabled = false;
    {% endif %}
});

// Toggle show all texts
function toggleShowAll() {
    const showAll = document.getElementById('showAllToggle').checked;
    const currentUrl = new URL(window.location.href);
    if (showAll) {
        currentUrl.searchParams.set('show_all', 'true');
    } else {
        currentUrl.searchParams.delete('show_all');
    }
    window.location.href = currentUrl.toString();
}

// Select text
function selectText() {
    const select = document.getElementById('textSelect');
    selectedTextId = select.value ? parseInt(select.value) : null;

    if (selectedTextId) {
        // Fetch text content
        const option = select.options[select.selectedIndex];
        const textContent = option.textContent.replace(/^\[ID: \d+\]\s*/, '');
        document.getElementById('textDisplay').textContent = textContent;
        document.getElementById('recordButton').disabled = false;
    } else {
        document.getElementById('textDisplay').textContent = 'ä¸Šã®ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„';
        document.getElementById('recordButton').disabled = true;
    }

    // Hide playback section when changing text
    document.getElementById('playbackSection').style.display = 'none';
}

// Toggle recording
async function toggleRecording() {
    if (!recorder.isRecording) {
        await startRecording();
    } else {
        await stopRecording();
    }
}

// Start recording
async function startRecording() {
    if (!selectedTextId) {
        alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }

    try {
        await recorder.start();

        // Update UI
        const button = document.getElementById('recordButton');
        button.textContent = 'â¬› åœæ­¢';
        button.classList.add('recording');

        const status = document.getElementById('statusDisplay');
        status.className = 'recording-status recording';
        document.getElementById('statusMessage').textContent = 'éŒ²éŸ³ä¸­...';
        document.getElementById('timer').style.display = 'block';

        // Start timer
        recordingStartTime = Date.now();
        updateTimer();
        timerInterval = setInterval(updateTimer, 100);

        // Hide playback section
        document.getElementById('playbackSection').style.display = 'none';
    } catch (error) {
        alert(error.message);
    }
}

// Stop recording
async function stopRecording() {
    try {
        recordedBlob = await recorder.stop();

        // Stop timer
        clearInterval(timerInterval);

        // Update UI
        const button = document.getElementById('recordButton');
        button.textContent = 'ğŸ¤ éŒ²éŸ³é–‹å§‹';
        button.classList.remove('recording');

        const status = document.getElementById('statusDisplay');
        status.className = 'recording-status idle';
        document.getElementById('statusMessage').textContent = 'éŒ²éŸ³å®Œäº†';
        document.getElementById('timer').style.display = 'none';

        // Show playback
        showPlayback();
    } catch (error) {
        alert('éŒ²éŸ³ã®åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    }
}

// Update timer display
function updateTimer() {
    const elapsed = (Date.now() - recordingStartTime) / 1000;
    const minutes = Math.floor(elapsed / 60);
    const seconds = Math.floor(elapsed % 60);
    document.getElementById('timer').textContent =
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

// Show playback
function showPlayback() {
    const audioElement = document.getElementById('audioPlayback');
    audioElement.src = URL.createObjectURL(recordedBlob);
    document.getElementById('playbackSection').style.display = 'block';
}

// Save recording
async function saveRecording() {
    if (!recordedBlob || !selectedTextId) {
        alert('éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }

    // Update UI
    const status = document.getElementById('statusDisplay');
    status.className = 'recording-status processing';
    document.getElementById('statusMessage').textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
    document.getElementById('recordButton').disabled = true;

    try {
        const result = await recorder.uploadToServer(selectedTextId, recordedBlob);

        // Success
        status.className = 'recording-status success';
        document.getElementById('statusMessage').textContent = result.message;

        // Show result
        document.getElementById('resultMessage').innerHTML = `
            <article>
                <h4>âœ… éŒ²éŸ³ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ</h4>
                <p>éŒ²éŸ³ID: ${result.recording.id}</p>
                <p>é•·ã•: ${result.recording.duration.toFixed(2)}ç§’</p>
                <p><a href="/recordings/">éŒ²éŸ³ä¸€è¦§ã‚’è¦‹ã‚‹</a></p>
            </article>
        `;

        // Reset
        setTimeout(() => {
            resetRecording();
        }, 3000);
    } catch (error) {
        status.className = 'recording-status idle';
        document.getElementById('statusMessage').textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—';
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        document.getElementById('recordButton').disabled = false;
    }
}

// Discard recording
function discardRecording() {
    if (confirm('éŒ²éŸ³ã‚’ç ´æ£„ã—ã¾ã™ã‹?')) {
        resetRecording();
    }
}

// Reset recording state
function resetRecording() {
    recordedBlob = null;
    document.getElementById('playbackSection').style.display = 'none';
    document.getElementById('resultMessage').innerHTML = '';

    const status = document.getElementById('statusDisplay');
    status.className = 'recording-status idle';
    document.getElementById('statusMessage').textContent = 'éŒ²éŸ³æº–å‚™å®Œäº†';

    document.getElementById('recordButton').disabled = false;
}
</script>
{% endblock %}
